<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="authStyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Connexion</title>
</head>
<body>
    <div class="container">
        <div class="inscription">
            <div class="formulaire">
                <div class="pub">
                    <div class="pub-container">
                        <div class="pub-elements">
                            <h1 style="font-weight: bold;">Météolia</h1>
                            <h3>Formulaire de connexion</h3>                         
                        </div>
                    </div>
                </div>
                <div class="form">
                    <form action="" id="form2">
                        <div class="form-input">
                            <label for="user-email">Email</label>
                            <br>
                            <input type="email" name="user-email" id="user-email-conn">
                            <i class="fa-solid fa-circle-check"></i>
                            <i class="fa-solid fa-exclamation"></i>
                            <small>massage d'erreur</small>
                        </div>
                        <div class="form-input">
                            <label for="user-password">Mot de passe</label>
                            <br>
                            <input type="password" name="user-paasword" id="user-password-conn">
                            <i class="fa-solid fa-circle-check"></i>
                            <i class="fa-solid fa-exclamation"></i>
                            <small>massage d'erreur</small>
                        </div>
                        <button type="submit" class="validation-button">Se connecter</button>
                        <p style="font-size: 18px; margin-top: 10px;">Vous n'avez pas de compte? inscrivez-vous <a href="signup.html">ici!</a></p>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        //Fomulaire de connexion
        const form2 = document.getElementById('form2');
        const userEmailConn = document.getElementById('user-email-conn');
        const userPasswordConn = document.getElementById('user-password-conn');

        form2.addEventListener('submit', event => {
            event.preventDefault();

            const verify = formVerifyConn();
        
            if(verify.isValid){
                loginUser(verify.emailConn, verify.passwordConn);
            }
            else{
                alert('Veuillez remplir correctement tous les champs');
            }
        })

        function formVerifyConn(){
            let isValid = true; 
        
            const emailConn = userEmailConn.value.trim();
            const passwordConn = userPasswordConn.value.trim();
        
            //email verification
            if (emailConn === "") {
                isValid = false;
                let messageConn = "Ce champs ne peut pas être vide!";
                setError(userEmailConn, messageConn);
            }    
            else if(emailVerificator(emailConn) === false){
                isValid = false;
                let messageConn = "Mauvais format de l'adresse email!";
                setError(userEmailConn, messageConn);    
            }
            else{
                setSuccess(userEmailConn);  
            }
        
            //password verification
            if (passwordConn === "") {
                isValid = false;
                let messageConn = "Ce champs ne peut pas être vide!";
                setError(userPasswordConn, messageConn);
            }   
            else if(passwordConn.length < 8){
                isValid = false;
                let messageConn = "8 caractères minimun pour ce champs!";
                setError(userPasswordConn, messageConn);
            } 
            else{
                setSuccess(userPasswordConn);  
            }
        
            return {isValid, emailConn, passwordConn};
        }

        function setError(element, message) {
            const formInput = element.parentElement;
            const small = formInput.querySelector('small');

            //Ajout de message d'erreur
            small.innerText = message;

            //Ajout de la classe error
            formInput.className = 'form-input error'
        }

        function setSuccess(element) {
            const formInput = element.parentElement;
        
            //Ajout de la classe error
            formInput.className = 'form-input success'
        }

        function emailVerificator(email){
            return email.match(/^[a-z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$/)
        }

        async function loginUser(email, password) {
            try {
                const response = await fetch('https://meteolia-backend.onrender.com/api/auth/login', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('token', data.token);
                    alert(data.message);
                    // Par exemple, rediriger vers la page chatbot
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Erreur: ' + data.message);
                }
            } catch (error) {
                console.error('Erreur lors de la connexion:', error);
            }
        }
    </script>
</body>
</html>
